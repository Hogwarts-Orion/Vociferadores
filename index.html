<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Profeta Rebelde - Sistema Avanzado</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Special+Elite&display=swap');

        :root {
            --oro: #c5a059;
            --oro-brillante: #d4af37;
            --sangre: #8b0000;
            --pergamino: #f4e4bc;
            --oscuro: #1a150f;
        }

        body {
            margin: 0; background: var(--oscuro);
            color: #2c1e11; font-family: 'Special Elite', cursive;
            display: flex; justify-content: center; padding: 10px;
        }

        .paper {
            background: var(--pergamino) url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            width: 100%; max-width: 500px; padding: 20px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8); border: 6px double #8b6d45;
            box-sizing: border-box; min-height: 100vh;
        }

        /* --- LOGIN M√ÅGICO --- */
        #pantalla-login {
            text-align: center; padding-top: 50px;
        }
        .input-login {
            padding: 15px; width: 80%; border: 2px solid var(--oro);
            margin: 10px 0; font-family: 'Cinzel'; font-size: 18px;
        }

        /* --- INTERFAZ PRINCIPAL --- */
        #interfaz-web { display: none; }

        header { text-align: center; border-bottom: 5px double var(--oscuro); margin-bottom: 20px; }
        header h1 { font-family: 'Cinzel', serif; font-size: 32px; margin: 10px 0; }

        .noticia-card {
            background: #fffdf5; padding: 15px; margin-bottom: 20px;
            border: 1px solid #d2b48c; position: relative;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.1);
        }

        .vociferadora {
            border: 3px solid var(--sangre) !important;
            animation: tremor 0.3s infinite;
        }
        @keyframes tremor { 0% { transform: rotate(0.3deg); } 100% { transform: rotate(-0.3deg); } }

        .tag { font-size: 10px; padding: 3px 7px; color: white; border-radius: 2px; font-weight: bold; }
        .Slytherin { background: #1a472a; } .Gryffindor { background: #740001; }
        .Hufflepuff { background: #ecb939; color: black; } .Ravenclaw { background: #0e1a40; }
        .OFICIAL { background: var(--oro); color: #000; }

        /* --- FORMULARIO --- */
        .box-envio {
            background: var(--oscuro); color: var(--pergamino);
            padding: 20px; border-radius: 8px; margin-top: 30px; border: 2px solid var(--oro);
        }
        input, textarea, select {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 2px solid var(--oro); border-radius: 4px; box-sizing: border-box;
            font-family: 'Special Elite';
        }

        .btn-accion {
            background: var(--oro-brillante); color: #000; border: none;
            padding: 15px; width: 100%; font-family: 'Cinzel';
            font-weight: 900; font-size: 18px; cursor: pointer; border-radius: 4px;
        }
        .btn-accion:disabled { background: #666; cursor: not-allowed; }

        .voto-btn {
            background: none; border: 1px solid var(--sangre); color: var(--sangre);
            width: 100%; padding: 8px; font-weight: bold; margin-top: 10px; cursor: pointer;
        }
        .voto-btn.voted { background: var(--sangre); color: white; opacity: 0.7; }
    </style>
</head>
<body>

    <div class="paper">
        <div id="pantalla-login">
            <h1 style="font-family: 'Cinzel';">IDENTIF√çCATE</h1>
            <p>Introduce tu nombre y casa para acceder a las noticias de Ori√≥n.</p>
            <input type="text" id="user-name" class="input-login" placeholder="Tu Nombre...">
            <select id="user-house" class="input-login" style="width: 88%;">
                <option value="Gryffindor">Gryffindor ü¶Å</option>
                <option value="Slytherin">Slytherin üêç</option>
                <option value="Hufflepuff">Hufflepuff ü¶°</option>
                <option value="Ravenclaw">Ravenclaw ü¶Ö</option>
            </select>
            <button class="btn-accion" onclick="iniciarSesion()">ENTRAR AL PROFETA ‚ú®</button>
        </div>

        <div id="interfaz-web">
            <header>
                <h1>EL PROFETA</h1>
                <div style="font-size: 12px; display:flex; justify-content:space-between;">
                    <span id="display-user"></span>
                    <span id="fecha-actual"></span>
                </div>
            </header>

            <div id="lista-oficial"></div>
            <div id="lista-chismes"></div>

            <div class="box-envio">
                <h3 style="margin:0; text-align:center; font-family:'Cinzel'; color:var(--oro);">üñãÔ∏è REDACTAR PRIMICIA</h3>
                <input type="text" id="post-titulo" placeholder="T√≠tulo de la noticia">
                <textarea id="post-texto" rows="4" placeholder="¬øQu√© esc√°ndalo quieres contar?"></textarea>
                <input type="text" id="post-img" placeholder="URL de Imagen/GIF (Opcional)">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="post-cat">
                        <option value="General">Categor√≠a: General</option>
                        <option value="OFICIAL">üñãÔ∏è Rango: PROFETA</option>
                    </select>
                    <select id="post-estilo">
                        <option value="normal">Estilo: Normal</option>
                        <option value="vociferadora">Estilo: Vociferadora üî•</option>
                    </select>
                </div>
                <input type="color" id="post-color" value="#8b0000" style="height:40px; border:none; background:none;">
                <button class="btn-accion" onclick="crearPost()">PUBLICAR AHORA ‚ú®</button>
            </div>
        </div>
    </div>

    <script>
        const DB_URL = "https://profeta-9c8df-default-rtdb.firebaseio.com/periodico";
        const CLAVE_ADMIN = "Orion2026";
        
        let currentUser = JSON.parse(localStorage.getItem('mago_sesion'));
        let misVotos = JSON.parse(localStorage.getItem('votos_realizados')) || [];

        // --- SISTEMA DE SESI√ìN ---
        function iniciarSesion() {
            const nombre = document.getElementById('user-name').value.trim();
            const casa = document.getElementById('user-house').value;
            if(!nombre) return alert("Debes identificarte ante el Ministerio.");
            
            currentUser = { nombre, casa };
            localStorage.setItem('mago_sesion', JSON.stringify(currentUser));
            mostrarWeb();
        }

        function mostrarWeb() {
            if(!currentUser) return;
            document.getElementById('pantalla-login').style.display = 'none';
            document.getElementById('interfaz-web').style.display = 'block';
            document.getElementById('display-user').innerText = `üë§ ${currentUser.nombre} (${currentUser.casa})`;
            document.getElementById('fecha-actual').innerText = new Date().toLocaleDateString();
            cargarNoticias();
        }

        // --- SISTEMA DE ENV√çO (CORREGIDO) ---
        function crearPost() {
            const titulo = document.getElementById('post-titulo').value.trim();
            const texto = document.getElementById('post-texto').value.trim();
            const cat = document.getElementById('post-cat').value;
            const img = document.getElementById('post-img').value;
            const estilo = document.getElementById('post-estilo').value;
            const color = document.getElementById('post-color').value;

            if(!titulo || !texto) return alert("¬°Por Merl√≠n! Rellena los campos.");

            let categoriaFinal = (cat === "OFICIAL") ? "OFICIAL" : currentUser.casa;
            if(cat === "OFICIAL" && prompt("Llave de Escritor:") !== CLAVE_ADMIN) return;

            const id = "POST_" + Date.now();
            const data = {
                id, titulo, texto, img, estilo, color,
                cat: categoriaFinal,
                autor: currentUser.nombre,
                votos: 0,
                fecha: new Date().toLocaleString()
            };

            fetch(`${DB_URL}/${id}.json`, {
                method: 'PUT',
                body: JSON.stringify(data)
            }).then(() => {
                alert("¬°Publicado con √©xito!");
                location.reload();
            }).catch(err => alert("Error de conexi√≥n m√°gica: " + err));
        }

        // --- CARGA Y VOTOS ---
        function cargarNoticias() {
            fetch(`${DB_URL}.json`).then(r => r.json()).then(data => {
                if(!data) return;
                const notas = Object.values(data).filter(n => n && n.id).reverse();
                
                const htmlOficial = [];
                const htmlChismes = [];

                notas.forEach(n => {
                    const yaVoto = misVotos.includes(n.id);
                    const cardHtml = `
                        <div class="noticia-card ${n.estilo === 'vociferadora' ? 'vociferadora' : ''}" style="border-left: 6px solid ${n.color}">
                            <span class="tag ${n.cat}">${n.cat}</span>
                            <h3 style="color:${n.color}; margin:10px 0; font-family:'Cinzel';">${n.titulo}</h3>
                            ${n.img ? `<img src="${n.img}" style="width:100%; border-radius:4px;">` : ''}
                            <p style="font-size:14px; line-height:1.4;">${n.texto}</p>
                            <small>‚Äî Escrito por: ${n.autor}</small>
                            <button class="voto-btn ${yaVoto ? 'voted' : ''}" 
                                    onclick="votar('${n.id}', ${n.votos || 0})" 
                                    ${yaVoto ? 'disabled' : ''}>
                                ${yaVoto ? '‚úÖ YA HAS VOTADO' : 'üî• ' + (n.votos || 0) + ' ¬°ESCANDALOSO!'}
                            </button>
                        </div>
                    `;
                    
                    if(n.cat === "OFICIAL") htmlOficial.push(cardHtml);
                    else htmlChismes.push(cardHtml);
                });

                document.getElementById('lista-oficial').innerHTML = `
                    <h2 style="font-family:'Cinzel'; font-size:18px; border-bottom:1px solid var(--oro);">üñãÔ∏è CR√ìNICAS OFICIALES</h2>
                    ${htmlOficial.join('')}
                `;
                document.getElementById('lista-chismes').innerHTML = `
                    <h2 style="font-family:'Cinzel'; font-size:18px; border-bottom:1px solid var(--oro); margin-top:30px;">üî• EL CHISME DEL D√çA</h2>
                    ${htmlChismes.join('')}
                `;
            });
        }

        async function votar(id, actual) {
            if(misVotos.includes(id)) return;

            // Registro local para evitar repetir voto
            misVotos.push(id);
            localStorage.setItem('votos_realizados', JSON.stringify(misVotos));

            // Actualizaci√≥n en Base de Datos
            await fetch(`${DB_URL}/${id}/votos.json`, { 
                method: 'PUT', 
                body: JSON.stringify(actual + 1) 
            });
            
            cargarNoticias();
        }

        // Auto-login si ya existe la sesi√≥n
        if(currentUser) mostrarWeb();
    </script>
</body>
</html>
